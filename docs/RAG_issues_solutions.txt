[Law-AI Local] RAG 파이프라인 문제 & 해결책 정리
=================================================

1) 데이터에 헌법 텍스트가 없음 → 일반 지식으로 대체
추론:
사용자가 제공한 txt파일은 헌법 제1조와 관련된 내용이 없음을 확인할 수 있습니다.
labor_basic.txt와 min_wage.txt는 근로기준법, 최저임금법 관련 문서로, 헌법 조문과는 무관합니다.
hello.txt는 법률 테스트 문서로, 계약 해지, 손해배상 등 노동 분쟁 관련 키워드만 포함되어 있습니다.
따라서 모델은 제공된 맥락 자료 없이 일반 지식을 기반으로 답변을 구성했습니다.
결과:
"대한민국 헌법 제1조는 헌법 자체의 내용을 담고 있지 않음"이라는 일반적 설명이 나왔습니다.
이는 데이터가 부족한 상태에서 모델이 상식을 활용해 답변했음을 의미합니다.

[권장 해결책]
- data/raw/constitution_kr.txt(헌법 원문) 추가 후 인덱싱 포함.
- 검색에서 constitution 관련 소스 가중치 ↑, 자료 부재 시 “자료에 없음” 명시.

2) CoT 누출 → 프롬프트/옵션에서 막지 않아 </think> 노출
추론:
응답 본문에 </think>라는 모델 내부 사고(Chain-of-Thought)가 노출됨.
결과:
데이터 부족 + CoT 누출로 부정확한 응답.

[권장 해결책]
- 프롬프트에 “내부 사고 출력 금지” 규칙 추가.
- stop 시퀀스에 </think>, <|assistant_thought|>, ```thinking 등 포함.
- 후처리(strip_think)로 재차 제거.

3) 소스 중복 → 재랭커 이후 동일 청크 2회 등장
추론:
sources에 동일 chunk가 중복 등장(재랭커/인덱싱/병합 로직 이슈 가능).
결과:
출처 신뢰도 저하.

[권장 해결책]
- ingest: ID 규칙 고도화 + existing-ID 조회로 중복 스킵.
- 검색: 파일당 최대 N개 제한 + 유사도 클러스터링/SimHash로 near-dup 제거.
- 재랭킹: bge-reranker-large 정상 로드/디바이스 확인, top_k 조정.

부록) 운영 체크리스트
- 인덱싱 컬렉션명 == 조회 컬렉션명(case_kb_m3 등)
- vectorstore 경로/권한 이슈 시 새 폴더로 전환
- chunk_size 800~1000, overlap 64~120 권장
- GPU 사용 시 embedder.device=cuda + CUDA wheel 설치